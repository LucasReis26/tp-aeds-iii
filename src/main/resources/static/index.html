<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilmBox - Painel de Testes da API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-darkest: #141414;
            --bg-color-dark: #1d1d1f;
            --primary-red: #e50914;
            --text-color: #f5f5f7;
            --text-muted: #8e8e93;
            --border-color: #3a3a3c;
            --border-radius: 8px;
            --success-color: #34c759;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: var(--bg-color-darkest);
            color: var(--text-color);
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-red);
            text-shadow: 0 0 10px rgba(229, 9, 20, 0.5);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .entity-column {
            background-color: var(--bg-color-dark);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .operation {
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .entity-column .operation:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        h2 {
            margin-top: 0;
            color: var(--primary-red);
            border-bottom: 1px solid var(--primary-red);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        h3 {
            font-size: 1.1em;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .badge-rsa {
            background-color: #e50914;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            vertical-align: middle;
            margin-left: 8px;
        }

        input,
        button {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 15px;
            margin-bottom: 1rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            background-color: #3a3a3c;
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            border: 1px solid #555;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.4);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        button {
            background-color: var(--primary-red);
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
        }

        button:hover {
            background-color: #b20710;
        }

        pre {
            background-color: #1c1c1e;
            padding: 1rem;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
        }

        pre.success {
            border-left: 4px solid var(--success-color);
            color: #d0d0d0;
        }

        pre.error {
            border-left: 4px solid var(--primary-red);
            color: #ffbaba;
        }
    </style>
</head>

<body>

    <header class="header">
        <h1>FilmBox API</h1>
        <p>Painel de Testes e Intera칞칚o com a Base de Dados</p>
    </header>

    <main class="grid-container">

        <section class="entity-column">
            <h2>Usu치rios <span class="badge-rsa">RSA SECURE</span></h2>
            <div class="operation">
                <h3>Criar Usu치rio</h3>
                <input id="user-username" placeholder="Nome de usu치rio (ex: 'alice')">
                <input id="user-description" placeholder="Descri칞칚o (ex: 'Gosta de drama')">
                <input id="user-password" type="password" placeholder="Senha (ser치 criptografada no DB)">
                <button
                    onclick="handleApiCall('user-create-result', 'POST', '/users', { username: getValue('user-username'), description: getValue('user-description'), password: getValue('user-password') })">Criar</button>
                <pre id="user-create-result"></pre>
            </div>
            <div class="operation">
                <h3>Gerenciar Usu치rio por ID</h3>
                <input id="user-id" type="number" placeholder="ID do Usu치rio">
                <button onclick="handleApiCall('user-manage-result', 'GET', `/users/${getValue('user-id')}`)">Buscar
                    (Descriptografa Auto)</button>
                <input id="user-new-username" placeholder="Novo nome de usu치rio (para alterar)">
                <input id="user-new-description" placeholder="Nova descri칞칚o (para alterar)">
                <button
                    onclick="handleApiCall('user-manage-result', 'PUT', `/users/${getValue('user-id')}`, { username: getValue('user-new-username'), description: getValue('user-new-description') })">Alterar</button>
                <button
                    onclick="handleApiCall('user-manage-result', 'DELETE', `/users/${getValue('user-id')}`)">Excluir</button>
                <pre id="user-manage-result"></pre>
            </div>
            <div class="operation">
                <h3>Listar Todos os Usu치rios</h3>
                <button onclick="handleApiCall('user-list-result', 'GET', '/users')">Listar Todos</button>
                <pre id="user-list-result"></pre>
            </div>
        </section>

        <section class="entity-column">
            <h2>Filmes</h2>
            <div class="operation">
                <h3>Criar Filme</h3>
                <input id="filme-title" placeholder="T칤tulo">
                <input id="filme-releaseDate" type="date">
                <input id="filme-score" type="number" placeholder="Score (0-100)">
                <input id="filme-duration" type="number" placeholder="Dura칞칚o (minutos)">
                <input id="filme-rating" type="number" placeholder="Classifica칞칚o Indicativa">
                <input id="filme-directors" placeholder="Diretores (separados por v칤rgula)">
                <input id="filme-actors" placeholder="Atores (separados por v칤rgula)">
                <button onclick="criarFilme()">Criar</button>
                <pre id="filme-create-result"></pre>
            </div>
            <div class="operation">
                <h3>Buscar / Excluir Filmes</h3>
                <input id="filme-id" type="number" placeholder="ID do Filme para buscar/excluir">
                <button onclick="handleApiCall('filme-search-result', 'GET', `/filmes/${getValue('filme-id')}`)">Buscar
                    por ID</button>
                <button
                    onclick="handleApiCall('filme-search-result', 'DELETE', `/filmes/${getValue('filme-id')}`)">Excluir
                    por ID</button>
                <input id="filme-search-title" placeholder="Termo de busca no T칤tulo">
                <button
                    onclick="handleApiCall('filme-search-result', 'GET', `/filmes/buscar?titulo=${getValue('filme-search-title')}`)">Buscar
                    por T칤tulo</button>
                <button onclick="handleApiCall('filme-search-result', 'GET', '/filmes')">Listar Todos</button>
                <pre id="filme-search-result"></pre>
            </div>
        </section>

        <section class="entity-column">
            <h2>Reviews</h2>
            <div class="operation">
                <h3>Criar Review</h3>
                <input id="review-userId" type="number" placeholder="ID do Usu치rio avaliador">
                <input id="review-filmeId" type="number" placeholder="ID do Filme avaliado">
                <input id="review-nota" type="number" step="0.1" placeholder="Nota (0.0 - 10.0)">
                <input id="review-comentario" placeholder="Coment치rio">
                <button onclick="criarReview()">Criar</button>
                <pre id="review-create-result"></pre>
            </div>
            <div class="operation">
                <h3>Atualizar Review</h3>
                <input id="review-update-id" type="number" placeholder="ID da Review a ser alterada">
                <input id="review-update-userId" type="number" placeholder="Seu ID de Usu치rio (para permiss칚o)">
                <input id="review-update-nota" type="number" step="0.1" placeholder="Nova Nota">
                <input id="review-update-comentario" placeholder="Novo Coment치rio">
                <button onclick="atualizarReview()">Atualizar</button>
                <pre id="review-update-result"></pre>
            </div>
            <div class="operation">
                <h3>Buscar / Excluir / Listar Reviews</h3>
                <input id="review-id" type="number" placeholder="ID da Review para buscar/excluir">
                <button onclick="handleApiCall('review-list-result', 'GET', `/reviews/${getValue('review-id')}`)">Buscar
                    por ID</button>
                <button
                    onclick="handleApiCall('review-list-result', 'DELETE', `/reviews/${getValue('review-id')}`)">Excluir
                    por ID</button>
                <input id="review-list-userId" type="number" placeholder="ID do Usu치rio para listar">
                <button
                    onclick="handleApiCall('review-list-result', 'GET', `/reviews/user/${getValue('review-list-userId')}`)">Listar
                    por Usu치rio</button>
                <input id="review-list-filmeId" type="number" placeholder="ID do Filme para listar">
                <button
                    onclick="handleApiCall('review-list-result', 'GET', `/reviews/filme/${getValue('review-list-filmeId')}`)">Listar
                    por Filme</button>
                <button onclick="handleApiCall('review-list-result', 'GET', '/reviews')">Listar Todas</button>
                <pre id="review-list-result"></pre>
            </div>
        </section>

        <section class="entity-column">
            <h2>Listas</h2>
            <div class="operation">
                <h3>Gerenciar Listas de Usu치rio</h3>
                <input id="lista-userId" type="number" placeholder="ID do Usu치rio">
                <button
                    onclick="handleApiCall('lista-user-result', 'POST', `/listas/user/${getValue('lista-userId')}/init-padrao`)">Criar
                    Listas Padr칚o</button>
                <input id="lista-nome" placeholder="Nome da Lista Personalizada">
                <button
                    onclick="handleApiCall('lista-user-result', 'POST', '/listas', { userId: parseInt(getValue('lista-userId')), nome: getValue('lista-nome'), padrao: false })">Criar
                    Lista Personalizada</button>
                <button
                    onclick="handleApiCall('lista-user-result', 'GET', `/listas/user/${getValue('lista-userId')}`)">Ver
                    Listas do Usu치rio</button>
                <button onclick="handleApiCall('lista-user-result', 'GET', '/listas')">Listar Todas as Listas</button>
                <pre id="lista-user-result"></pre>
            </div>
            <div class="operation">
                <h3>Gerenciar Filmes em Listas</h3>
                <input id="lista-id-rel" type="number" placeholder="ID da Lista">
                <input id="filme-id-rel" type="number" placeholder="ID do Filme">
                <button
                    onclick="handleApiCall('lista-rel-result', 'POST', `/listas/${getValue('lista-id-rel')}/filmes/${getValue('filme-id-rel')}`)">Adicionar
                    Filme</button>
                <button
                    onclick="handleApiCall('lista-rel-result', 'DELETE', `/listas/${getValue('lista-id-rel')}/filmes/${getValue('filme-id-rel')}`)">Remover
                    Filme</button>
                <pre id="lista-rel-result"></pre>
            </div>
            <div class="operation">
                <h3>Alterar / Excluir Lista</h3>
                <input id="lista-id-manage" type="number" placeholder="ID da Lista">
                <input id="lista-new-name" placeholder="Novo Nome (para alterar)">
                <button
                    onclick="handleApiCall('lista-manage-result', 'PUT', `/listas/${getValue('lista-id-manage')}`, { nome: getValue('lista-new-name') })">Alterar
                    Nome</button>
                <button
                    onclick="handleApiCall('lista-manage-result', 'DELETE', `/listas/${getValue('lista-id-manage')}`)">Excluir
                    Lista</button>
                <pre id="lista-manage-result"></pre>
            </div>
        </section>
        <!-- SE칂츾O: Compacta칞칚o / Descompacta칞칚o -->


<!-- SE칂츾O: Compacta칞칚o / Descompacta칞칚o -->
<section class="entity-column">
    <h2>Compacta칞칚o</h2>

    <!-- LZW -->
    <div class="operation">
        <h3>LZW</h3>
        <p style="color:var(--text-muted); margin-bottom: 1rem;">
            Compacte todo o diret칩rio <code>data/</code> em <code>db_backup.lzw</code>.
        </p>

        <button onclick="compactarLZW()">Compactar (LZW)</button>

        <div style="margin-top:0.75rem; margin-bottom:0.25rem;">
            <input id="inputRestoreFile" type="file" accept=".lzw"
                style="width:100%; padding:8px; border-radius:6px; background:#3a3a3c; border:1px solid #555; color:var(--text-color);">
        </div>

        <button style="margin-top:6px;" onclick="descompactarLZW()">Descompactar (LZW)</button>

        <pre id="resultadoLZW" style="margin-top:12px;"></pre>
    </div>

<!-- HUFFMAN -->
<div class="operation">
    <h3>Huffman</h3>
    <p style="color:var(--text-muted); margin-bottom: 1rem;">
        Compacte todo o diret칩rio <code>data/</code> em <code>db_backup.huf</code>.
    </p>

    <button onclick="compactarHuffman()">Compactar (Huffman)</button>

    <div style="margin-top:0.75rem; margin-bottom:0.25rem;">
        <input id="inputRestoreHuff" type="file" accept=".huf"
            style="width:100%; padding:8px; border-radius:6px; background:#3a3a3c; border:1px solid #555; color:var(--text-color);">
    </div>

    <button style="margin-top:6px;" onclick="descompactarHuffman()">Descompactar (Huffman)</button>

    <pre id="resultadoHuffman" style="margin-top:12px;"></pre>

    <div id="taxasHuffman" style="display:none; margin-top:15px; padding:12px; background:#1c1c1e; border-radius:8px; border:1px solid #333;">
        <h4 style="margin-top:0;">Taxas de Compress칚o (Huffman)</h4>
        <p><strong>Tamanho Original:</strong> <span id="huff-orig"></span> bytes</p>
        <p><strong>Tamanho Comprimido:</strong> <span id="huff-comp"></span> bytes</p>
        <p><strong>Taxa de Compress칚o:</strong> <span id="huff-taxa"></span>%</p>
    </div>
</div>


</section>



    </main>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';

        function getValue(id) {
            return document.getElementById(id).value;
        }

        async function handleApiCall(resultDivId, method, endpoint, body = null, customHeaders = {}) {
            const resultDiv = document.getElementById(resultDivId);
            resultDiv.textContent = 'Executando...';
            resultDiv.className = '';

            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...customHeaders },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

                const contentType = response.headers.get("content-type");
                let responseData;

                if (response.status === 204) {
                    responseData = `Sucesso! (Status: 204 No Content)`;
                } else if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                if (!response.ok) {
                    let errorMessage = responseData;
                    if (typeof responseData === 'object' && responseData !== null && responseData.message) {
                        errorMessage = responseData.message;
                    } else if (typeof responseData === 'object') {
                        errorMessage = JSON.stringify(responseData);
                    }
                    throw new Error(`Status ${response.status}: ${errorMessage}`);
                }

                resultDiv.classList.add('success');
                if (typeof responseData === 'object') {
                    resultDiv.textContent = `Sucesso! (Status: ${response.status})\n\n${JSON.stringify(responseData, null, 2)}`;
                } else {
                    resultDiv.textContent = `Sucesso! (Status: ${response.status})\n\n${responseData}`;
                }

            } catch (error) {
                resultDiv.classList.add('error');
                resultDiv.textContent = `Falha:\n${error.toString()}`;
            }
        }

        function criarFilme() {
            const body = {
                title: getValue('filme-title'),
                releaseDate: getValue('filme-releaseDate'),
                score: parseInt(getValue('filme-score')) || 0,
                duration: parseInt(getValue('filme-duration')) || 0,
                rating: parseInt(getValue('filme-rating')) || 0,
                directors: getValue('filme-directors').split(',').map(s => s.trim()).filter(Boolean),
                actors: getValue('filme-actors').split(',').map(s => s.trim()).filter(Boolean)
            };
            handleApiCall('filme-create-result', 'POST', '/filmes', body);
        }

        function criarReview() {
            const body = {
                userId: parseInt(getValue('review-userId')),
                filmeId: parseInt(getValue('review-filmeId')),
                nota: parseFloat(getValue('review-nota')),
                comentario: getValue('review-comentario')
            };
            handleApiCall('review-create-result', 'POST', '/reviews', body);
        }

        function atualizarReview() {
            const reviewId = getValue('review-update-id');
            const userId = getValue('review-update-userId');
            if (!reviewId || !userId) {
                alert('Por favor, informe o ID da Review e o seu ID de Usu치rio para a permiss칚o.');
                return;
            }
            const body = {
                nota: parseFloat(getValue('review-update-nota')),
                comentario: getValue('review-update-comentario')
            };
            const headers = {
                'X-User-ID': userId
            };
            handleApiCall('review-update-result', 'PUT', `/reviews/${reviewId}`, body, headers);
        }
    
       
        async function compactarLZW() {
            const resultadoEl = document.getElementById('resultadoLZW');
            resultadoEl.className = '';
            resultadoEl.textContent = 'Gerando arquivo...';

            try {
         
            const headers = {};
            const tokenMeta = document.querySelector('meta[name="_csrf"]');
            const headerMeta = document.querySelector('meta[name="_csrf_header"]');
            if (tokenMeta && headerMeta) {
                headers[ headerMeta.getAttribute('content') ] = tokenMeta.getAttribute('content');
            }

            const resp = await fetch(`${API_BASE_URL}/compress-db`, {
                method: 'POST',
                headers: headers
            });

            if (!resp.ok) {
                const txt = await resp.text();
                resultadoEl.classList.add('error');
                resultadoEl.textContent = 'Erro: ' + txt;
                return;
            }

            const blob = await resp.blob();

         
            const cd = resp.headers.get('Content-Disposition') || resp.headers.get('content-disposition');
            let filename = 'db_backup.lzw';
            if (cd) {
                const m = /filename="?([^"]+)"?/.exec(cd);
                if (m && m[1]) filename = m[1];
            }

           
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            resultadoEl.classList.add('success');
            resultadoEl.textContent = 'Download iniciado: ' + filename;
            } catch (err) {
            console.error(err);
            resultadoEl.classList.add('error');
            resultadoEl.textContent = 'Erro ao compactar: ' + err.toString();
            } finally {
            setTimeout(()=> { resultadoEl.textContent = ''; resultadoEl.className = ''; }, 4000);
            }
        }

        async function descompactarLZW() {
            const resultadoEl = document.getElementById('resultadoLZW');
            const inputRestoreFile = document.getElementById('inputRestoreFile');
            resultadoEl.className = '';
            resultadoEl.textContent = 'Executando descompacta칞칚o...';

            try {
       
            const headers = {};
            const tokenMeta = document.querySelector('meta[name="_csrf"]');
            const headerMeta = document.querySelector('meta[name="_csrf_header"]');
            if (tokenMeta && headerMeta) {
                headers[ headerMeta.getAttribute('content') ] = tokenMeta.getAttribute('content');
            }

            const fd = new FormData();
            if (inputRestoreFile && inputRestoreFile.files.length > 0) {
                fd.append('file', inputRestoreFile.files[0]);
            }

            const resp = await fetch(`${API_BASE_URL}/decompress-db`, {
                method: 'POST',
                headers: headers, 
                body: fd
            });

            const text = await resp.text();
            if (!resp.ok) {
                resultadoEl.classList.add('error');
                resultadoEl.textContent = 'Erro: ' + text;
            } else {
                resultadoEl.classList.add('success');
                resultadoEl.textContent = text;
            }
            } catch (err) {
            console.error(err);
            resultadoEl.classList.add('error');
            resultadoEl.textContent = 'Erro ao descompactar: ' + err.toString();
            } finally {
            setTimeout(()=> { resultadoEl.textContent = ''; resultadoEl.className = ''; }, 5000);
            }
        }

async function compactarHuffman() {
    const resultadoEl = document.getElementById('resultadoHuffman');
    const taxasBox = document.getElementById('taxasHuffman');
    resultadoEl.className = '';
    resultadoEl.textContent = 'Gerando arquivo...';
    taxasBox.style.display = 'none';

    try {
        const resp = await fetch(`${API_BASE_URL}/compress-db-huffman`, {
            method: 'POST'
        });

        if (!resp.ok) {
            const txt = await resp.text();
            resultadoEl.classList.add('error');
            resultadoEl.textContent = 'Erro: ' + txt;
            return;
        }

        const blob = await resp.blob();

        // ---------------------------
        // 游늷 LEITURA DOS HEADERS
        // ---------------------------
        const origSize = Number(resp.headers.get("X-Original-Size"));
        const compSize = Number(resp.headers.get("Content-Length"));
        const taxa = ((1 - compSize / origSize) * 100).toFixed(2);

        // Exibir na tela
        document.getElementById("huff-orig").textContent = origSize;
        document.getElementById("huff-comp").textContent = compSize;
        document.getElementById("huff-taxa").textContent = taxa;
        taxasBox.style.display = 'block';

        // ---------------------------
        // 游늷 DOWNLOAD AUTOM츼TICO
        // ---------------------------
        const cd = resp.headers.get("Content-Disposition");
        let filename = "db_backup.huf";
        if (cd) {
            const m = /filename="?([^"]+)"?/.exec(cd);
            if (m && m[1]) filename = m[1];
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        resultadoEl.classList.add('success');
        resultadoEl.textContent = 'Download iniciado: ' + filename;

    } catch (err) {
        resultadoEl.classList.add('error');
        resultadoEl.textContent = 'Erro ao compactar: ' + err.toString();
    }
}

async function descompactarHuffman() {
    const resultadoEl = document.getElementById('resultadoHuffman');
    const inputFile = document.getElementById('inputRestoreHuff');

    resultadoEl.className = '';
    resultadoEl.textContent = 'Gerando arquivo ZIP...';

    try {
        const form = new FormData();
        if (inputFile.files.length > 0) {
            form.append("file", inputFile.files[0]);
        }

        const resp = await fetch(`${API_BASE_URL}/decompress-db-huffman`, {
            method: "POST",
            body: form
        });

        if (!resp.ok) {
            const txt = await resp.text();
            resultadoEl.classList.add('error');
            resultadoEl.textContent = 'Erro: ' + txt;
            return;
        }

        // O servidor deve retornar um ZIP agora
        const blob = await resp.blob();

        let filename = "restaurado.zip";
        const cd = resp.headers.get("Content-Disposition");
        if (cd) {
            const m = /filename="?([^"]+)"?/.exec(cd);
            if (m && m[1]) filename = m[1];
        }

        // Download autom치tico
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        resultadoEl.classList.add('success');
        resultadoEl.textContent = "Download iniciado: " + filename;

    } catch (err) {
        resultadoEl.classList.add('error');
        resultadoEl.textContent = "Erro ao descompactar: " + err.toString();
    }
}



    </script>
</body>

</html>